<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>UniCamillus Chemistry Trainer</title>
  <style>
    :root {
      color-scheme: dark;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #0f172a, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      color: #e5e7eb;
    }
    .app {
      width: 100%;
      max-width: 900px;
      background: #020617ee;
      border-radius: 24px;
      border: 1px solid #1f2937;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
      padding: 16px 16px 20px;
    }
    @media (min-width: 768px){
      .app { padding: 20px 24px 24px; }
    }
    h1 { margin: 0 0 4px; font-size: 1.4rem; }
    .sub { font-size: 0.8rem; color: #9ca3af; }
    .top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .pill-group {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: #020617;
    }
    .pill {
      border-radius: 999px;
      border: none;
      background: transparent;
      padding: 6px 10px;
      font-size: 0.75rem;
      color: #e5e7eb;
    }
    .pill.active {
      background: #22c55e;
      color: #020617;
      font-weight: 600;
    }
    .screen { margin-top: 10px; display: none; }
    .screen.active { display: block; }

    .card {
      background: #020617cc;
      border-radius: 16px;
      border: 1px solid #1f2937;
      padding: 12px;
      margin-bottom: 10px;
    }
    .btn {
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #020617;
      padding: 10px 14px;
      font-size: 0.9rem;
      font-weight: 600;
      width: 100%;
      margin-top: 8px;
    }
    .btn.secondary {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #374151;
      font-weight: 500;
    }
    .btn:disabled {
      background: #1f2937;
      color: #6b7280;
    }

    .topic-box-title {
      font-size: 0.8rem;
      color: #9ca3af;
      margin: 6px 0 4px;
    }
    .topic-buttons, .difficulty-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .topic-btn, .difficulty-btn {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.75rem;
      padding: 5px 10px;
    }
    .topic-btn.active, .difficulty-btn.active {
      background: #22c55e;
      color: #020617;
      border-color: #22c55e;
      font-weight: 600;
    }

    .q-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .q-text { font-size: 1rem; line-height: 1.5; }
    .options {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .opt-btn {
      border-radius: 14px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 8px 10px;
      font-size: 0.9rem;
      display: flex;
      gap: 6px;
      align-items: flex-start;
      text-align: left;
    }
    .opt-btn.correct {
      border-color: #22c55e;
      background: #22c55e22;
      color: #bbf7d0;
    }
    .opt-btn.wrong {
      border-color: #f97373;
      background: #f9737322;
      color: #fecaca;
    }
    .opt-btn.selected:not(.correct):not(.wrong) {
      border-color: #22c55e;
    }
    .letter {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 3px;
      min-width: 16px;
    }
    .state-tag {
      margin-left: auto;
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .progress-outer {
      margin-top: 8px;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
    }
    .progress-inner {
      height: 100%;
      width: 0%;
      background: #22c55e;
      transition: width 0.2s ease;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #22c55e66;
      background: #22c55e22;
      color: #6ee7b7;
    }
    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    ul.review-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 380px;
      overflow-y: auto;
    }
    ul.review-list li {
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #111827;
      font-size: 0.85rem;
    }
    .tag-wrong  { color:#fecaca; font-size:0.75rem; }
    .tag-correct{ color:#bbf7d0; font-size:0.75rem; }
    .tag-exp    { color:#9ca3af; font-size:0.75rem; margin-top:2px; }

    .foot {
      margin-top: 10px;
      font-size: 0.7rem;
      color: #6b7280;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="top-row">
    <div>
      <h1>UniCamillus Chemistry Trainer</h1>
      <p class="sub" id="subtitle">
        ホーム画面から分野と難易度を選んで、10問ずつトレーニングできます。
      </p>
    </div>
    <div>
      <div class="pill-group">
        <button class="pill active" id="lang-ja">日本語</button>
        <button class="pill" id="lang-en">English</button>
      </div>
    </div>
  </div>

  <!-- ホーム画面 -->
  <div id="screen-home" class="screen active">
    <div class="card">
      <p id="home-text">
        分野と難易度を選んで「10問テスト」を押すと、その条件からランダムに10問出題されます。
      </p>

      <p class="topic-box-title" id="topic-title">分野を選択:</p>
      <div id="topic-buttons" class="topic-buttons"></div>

      <p class="topic-box-title" id="diff-title">難易度を選択:</p>
      <div id="difficulty-buttons" class="difficulty-buttons"></div>

      <div class="stats-row" id="last-session-row" style="display:none;">
        <span id="last-score-text"></span>
        <span id="last-date-text"></span>
      </div>
    </div>
    <button class="btn" id="btn-start-main">選んだ条件で10問テスト</button>
    <button class="btn secondary" id="btn-start-review" disabled>
      復習モード（前回の間違えた問題）
    </button>
  </div>

  <!-- クイズ画面 -->
  <div id="screen-quiz" class="screen">
    <div class="card">
      <div class="q-header">
        <span id="q-counter">Q 1 / 10</span>
        <span id="q-topic"></span>
      </div>
      <div class="badge">
        <span class="badge-dot"></span>
        <span id="badge-text">レベル: 基礎</span>
      </div>
      <p class="q-text" id="q-text"></p>
    </div>
    <div class="card">
      <div id="options" class="options"></div>

      <button class="btn" id="btn-submit">回答する</button>
      <button class="btn secondary" id="btn-next" style="display:none;">次の問題へ</button>
      <!-- 途中でもホームに戻れるボタン -->
      <button class="btn secondary" id="btn-quit-home">ホームに戻る（この回は破棄）</button>

      <div id="explanation-box" style="display:none; margin-top:8px; font-size:0.85rem;">
        <strong id="exp-title">解説</strong>
        <div id="exp-body"></div>
      </div>

      <div class="stats-row">
        <span id="stat-correct">正解数: 0</span>
        <span id="stat-accuracy">正答率: 0%</span>
      </div>
      <div class="progress-outer">
        <div class="progress-inner" id="progress-bar"></div>
      </div>
    </div>
  </div>

  <!-- 結果画面 -->
  <div id="screen-result" class="screen">
    <div class="card">
      <h2 id="result-title" style="margin:0 0 4px; font-size:1.1rem;">結果</h2>
      <p id="result-summary" style="margin:0 0 6px; font-size:0.9rem;"></p>
      <div class="stats-row">
        <span id="result-detail-1"></span>
        <span id="result-detail-2"></span>
      </div>
    </div>

    <div class="card" id="review-card" style="display:none;">
      <p style="font-size:0.85rem; margin:0 0 6px;" id="review-title">
        間違えた問題（解説つき）
      </p>
      <ul class="review-list" id="review-list"></ul>
    </div>

    <button class="btn" id="btn-restart-main">もう一度 10問テスト</button>
    <button class="btn secondary" id="btn-restart-review" disabled>
      間違えた問題だけで再テスト
    </button>
    <button class="btn secondary" id="btn-back-home">
      ホームに戻る
    </button>
  </div>

  <p class="foot" id="footer">
    このアプリは UniCamillus 医学部レベルの一般化学を想定した個人学習用ツールです。成績は端末内ローカルに保存されます。
  </p>
</div>

<script>
  // ====== 状態 ======
  let lang = "ja";
  let selectedTopic = "all";        // all / thermo / equilibrium / acids / buffer / kinetics
  let selectedLevel = "all";        // all / basic / intermediate
  const TOTAL_PER_SESSION = 10;     // ★ 10問固定

  let sessionQuestions = [];
  let sessionAnswers = [];
  let currentIndex = 0;
  let score = 0;
  let bestStreak = 0;
  let currentStreak = 0;

  // ====== テキスト類 ======
  const TOPIC_DEFS = {
    all:        { ja:"全分野",       en:"All topics" },
    thermo:     { ja:"熱力学",       en:"Thermodynamics" },
    equilibrium:{ ja:"化学平衡",     en:"Equilibrium" },
    acids:      { ja:"酸と塩基",     en:"Acids & Bases" },
    buffer:     { ja:"緩衝溶液",     en:"Buffer solutions" },
    kinetics:   { ja:"反応速度論",   en:"Kinetics" }
  };
  const LEVEL_DEFS = {
    all:        { ja:"全レベル",     en:"All levels" },
    basic:      { ja:"基礎",         en:"Basic" },
    intermediate:{ja:"応用",         en:"Intermediate" }
  };

  const TEXT = {
    subtitle: {
      ja:"ホーム画面から分野と難易度を選んで、10問ずつトレーニングできます。",
      en:"Choose topic and difficulty on the home screen and practice 10 questions at a time."
    },
    homeText: {
      ja:"分野と難易度を選んで「10問テスト」を押すと、その条件からランダムに10問出題されます。",
      en:"Select topic and difficulty, then start a 10-question test from that pool."
    },
    topicTitle:{ ja:"分野を選択:", en:"Choose topic:" },
    diffTitle: { ja:"難易度を選択:", en:"Choose difficulty:" },
    btnMain:   { ja:"選んだ条件で10問テスト", en:"Start 10-question test" },
    btnReview: { ja:"復習モード（前回の間違えた問題）", en:"Review mode (missed questions)" },
    btnSubmit: { ja:"回答する", en:"Submit answer" },
    btnNext:   { ja:"次の問題へ", en:"Next question" },
    btnQuitHome:{ ja:"ホームに戻る（この回は破棄）", en:"Back to home (discard this run)" },
    expTitle:  { ja:"解説", en:"Explanation" },
    statCorrect:{ ja:"正解数", en:"Correct" },
    statAccuracy:{ ja:"正答率", en:"Accuracy" },
    levelBasic: { ja:"レベル: 基礎", en:"Level: Basic" },
    levelInter: { ja:"レベル: 応用", en:"Level: Intermediate" },
    qCounter:{
      ja:(i,t)=>`問題 ${i} / ${t}`,
      en:(i,t)=>`Question ${i} / ${t}`
    },
    resultTitle:{ ja:"結果", en:"Result" },
    resultSummary:{
      ja:(s,p,t,l)=>`${TOPIC_DEFS[t].ja}・${LEVEL_DEFS[l].ja}：${TOTAL_PER_SESSION}問中 ${s} 問正解（${p}%）でした。`,
      en:(s,p,t,l)=>`${TOPIC_DEFS[t].en} / ${LEVEL_DEFS[l].en}: you answered ${s} of ${TOTAL_PER_SESSION} questions correctly (${p}%).`
    },
    resultDetail1:{
      ja:(c)=>`連続正解数のベスト: ${c}`,
      en:(c)=>`Best correct streak: ${c}`
    },
    resultDetail2:{
      ja:(w)=>`間違えた問題: ${w} 問`,
      en:(w)=>`Number of missed questions: ${w}`
    },
    reviewTitle:{
      ja:"間違えた問題（解説つき）",
      en:"Missed questions (with explanations)"
    },
    tagYour:{ ja:"あなたの回答", en:"Your answer" },
    tagCorrect:{ ja:"正解", en:"Correct answer" },
    tagWrong:{ ja:"不正解", en:"Wrong" },
    btnRestartMain:{ ja:"もう一度 10問テスト", en:"Take another 10-question test" },
    btnRestartReview:{ ja:"間違えた問題だけで再テスト", en:"Retest missed questions only" },
    btnBackHome:{ ja:"ホームに戻る", en:"Back to home" },
    footer:{
      ja:"このアプリは UniCamillus 医学部レベルの一般化学を想定した個人学習用ツールです。成績は端末内ローカルに保存されます。",
      en:"This app targets General Chemistry level for UniCamillus medical students. Scores are stored only on this device."
    },
    correctLabel:{ ja:"正解", en:"Correct" },
    wrongLabel:{ ja:"不正解", en:"Wrong" }
  };

  // ====== 問題バンク（ここは前と同じ方針で増やせる） ======
  const BASE_QUESTIONS = [
    {
      id:"thermo-1",
      topic:"thermo",
      level:"intermediate",
      q:{
        ja:"反応 A → B において ΔH = −40 kJ/mol, ΔS = −120 J/mol·K のとき、自発的になるのはどの温度領域ですか？",
        en:"For reaction A → B with ΔH = −40 kJ/mol and ΔS = −120 J/mol·K, in which temperature range is it spontaneous?"
      },
      choices:[
        {ja:"すべての温度で自発的",en:"Spontaneous at all temperatures"},
        {ja:"低温でのみ自発的",en:"Spontaneous only at low temperatures"},
        {ja:"高温でのみ自発的",en:"Spontaneous only at high temperatures"},
        {ja:"いかなる温度でも自発的でない",en:"Never spontaneous"},
        {ja:"ΔH と ΔS からは判断できない",en:"Cannot be determined from ΔH and ΔS"}
      ],
      correct:1,
      exp:{
        ja:"ΔG = ΔH − TΔS。ΔH<0 かつ ΔS<0 のとき、低温では ΔH が支配的になり ΔG<0 となるので低温で自発的。",
        en:"ΔG = ΔH − TΔS. With ΔH<0 and ΔS<0, ΔG<0 at low temperature, so the reaction is spontaneous at low T."
      }
    },
    {
      id:"acid-1",
      topic:"acids",
      level:"basic",
      q:{
        ja:"Brønsted–Lowry の定義で酸とは何ですか？",
        en:"According to Brønsted–Lowry, what is an acid?"
      },
      choices:[
        {ja:"電子対を受け取る物質",en:"Electron-pair acceptor"},
        {ja:"プロトンを受け取る物質",en:"Proton (H⁺) acceptor"},
        {ja:"プロトンを与える物質",en:"Proton (H⁺) donor"},
        {ja:"電子対を与える物質",en:"Electron-pair donor"},
        {ja:"pH を上げる物質",en:"Any substance that raises pH"}
      ],
      correct:2,
      exp:{
        ja:"Brønsted–Lowry 酸は「プロトン (H⁺) を与える物質」です。",
        en:"A Brønsted–Lowry acid is a proton (H⁺) donor."
      }
    }
    // ★ 他の分野の問題もここにどんどん足していく
  ];

  // 自動生成 pH 問題で酸・塩基の基礎レベルを大量追加
  const AUTO_QUESTIONS = [];
  function generatePHQuestions(n){
    for(let i=0;i<n;i++){
      const m = Math.floor(Math.random()*9)+1;
      const e = Math.floor(Math.random()*7)+1;
      const conc = `${m}×10⁻${e}`;
      const pHtrue = e - Math.log10(m);
      const pHround = Math.round(pHtrue*100)/100;

      const choices=[];
      const correctIndex = Math.floor(Math.random()*5);
      for(let j=0;j<5;j++){
        if(j===correctIndex){
          choices.push(pHround);
        }else{
          let delta = Math.random()*1.2-0.6;
          let v = Math.round((pHtrue+delta)*100)/100;
          if(v===pHround) v+=0.14;
          choices.push(v);
        }
      }
      AUTO_QUESTIONS.push({
        id:`ph-${i}`,
        topic:"acids",
        level:"basic",
        q:{
          ja:`[H₃O⁺] = ${conc} M の水溶液の pH（小数第2位まで）は？`,
          en:`What is the pH (to two decimal places) of a solution with [H₃O⁺] = ${conc} M?`
        },
        choices:choices.map(v=>({
          ja:`pH ≈ ${v.toFixed(2)}`,
          en:`pH ≈ ${v.toFixed(2)}`
        })),
        correct:correctIndex,
        exp:{
          ja:`pH = −log[H₃O⁺] より pH ≈ ${pHround.toFixed(2)}。`,
          en:`Using pH = −log[H₃O⁺], pH ≈ ${pHround.toFixed(2)}.`
        }
      });
    }
  }
  generatePHQuestions(200); // とりあえず200問追加（あとで増やせる）

  const QUESTION_BANK = BASE_QUESTIONS.concat(AUTO_QUESTIONS);

  // ====== DOM ======
  const screenHome   = document.getElementById("screen-home");
  const screenQuiz   = document.getElementById("screen-quiz");
  const screenResult = document.getElementById("screen-result");

  const subtitle     = document.getElementById("subtitle");
  const homeText     = document.getElementById("home-text");
  const topicTitle   = document.getElementById("topic-title");
  const diffTitle    = document.getElementById("diff-title");
  const topicButtonsDiv = document.getElementById("topic-buttons");
  const diffButtonsDiv  = document.getElementById("difficulty-buttons");

  const btnStartMain   = document.getElementById("btn-start-main");
  const btnStartReview = document.getElementById("btn-start-review");
  const btnRestartMain = document.getElementById("btn-restart-main");
  const btnRestartReview = document.getElementById("btn-restart-review");
  const btnBackHome    = document.getElementById("btn-back-home");
  const btnQuitHome    = document.getElementById("btn-quit-home");

  const qCounter   = document.getElementById("q-counter");
  const qTopic     = document.getElementById("q-topic");
  const badgeText  = document.getElementById("badge-text");
  const qText      = document.getElementById("q-text");
  const optionsDiv = document.getElementById("options");
  const btnSubmit  = document.getElementById("btn-submit");
  const btnNext    = document.getElementById("btn-next");

  const explanationBox = document.getElementById("explanation-box");
  const expTitle       = document.getElementById("exp-title");
  const expBody        = document.getElementById("exp-body");

  const statCorrect = document.getElementById("stat-correct");
  const statAccuracy= document.getElementById("stat-accuracy");
  const progressBar = document.getElementById("progress-bar");

  const resultTitle   = document.getElementById("result-title");
  const resultSummary = document.getElementById("result-summary");
  const resultDetail1 = document.getElementById("result-detail-1");
  const resultDetail2 = document.getElementById("result-detail-2");
  const reviewCard    = document.getElementById("review-card");
  const reviewTitle   = document.getElementById("review-title");
  const reviewList    = document.getElementById("review-list");

  const lastSessionRow= document.getElementById("last-session-row");
  const lastScoreText = document.getElementById("last-score-text");
  const lastDateText  = document.getElementById("last-date-text");
  const footer        = document.getElementById("footer");

  // ====== 共通関数 ======
  function showScreen(name){
    [screenHome,screenQuiz,screenResult].forEach(s=>s.classList.remove("active"));
    if(name==="home") screenHome.classList.add("active");
    if(name==="quiz") screenQuiz.classList.add("active");
    if(name==="result") screenResult.classList.add("active");
  }
  function shuffle(a){
    const arr=a.slice();
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  function getStoredWrongIds(){
    try{
      const raw = localStorage.getItem("chem_last_wrong_ids");
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr)?arr:[];
    }catch{ return []; }
  }
  function updateLastSession(){
    const score = localStorage.getItem("chem_last_score");
    const date  = localStorage.getItem("chem_last_date");
    if(!score||!date){
      lastSessionRow.style.display="none";
      btnStartReview.disabled = !getStoredWrongIds().length;
      return;
    }
    lastSessionRow.style.display="flex";
    const d=new Date(date);
    lastScoreText.textContent =
      (lang==="ja"?"前回のスコア: ":"Last score: ")+score+"%";
    lastDateText.textContent =
      (lang==="ja"?"実施日: ":"Date: ")+d.toLocaleString();
    btnStartReview.disabled = !getStoredWrongIds().length;
  }

  // ====== 言語切り替え ======
  function renderTopicButtons(){
    topicButtonsDiv.innerHTML="";
    Object.keys(TOPIC_DEFS).forEach(key=>{
      const b=document.createElement("button");
      b.className="topic-btn"+(key===selectedTopic?" active":"");
      b.textContent=TOPIC_DEFS[key][lang];
      b.onclick=()=>{selectedTopic=key;renderTopicButtons();};
      topicButtonsDiv.appendChild(b);
    });
  }
  function renderDiffButtons(){
    diffButtonsDiv.innerHTML="";
    Object.keys(LEVEL_DEFS).forEach(key=>{
      const b=document.createElement("button");
      b.className="difficulty-btn"+(key===selectedLevel?" active":"");
      b.textContent=LEVEL_DEFS[key][lang];
      b.onclick=()=>{selectedLevel=key;renderDiffButtons();};
      diffButtonsDiv.appendChild(b);
    });
  }

  function applyLanguage(){
    subtitle.textContent = TEXT.subtitle[lang];
    homeText.textContent = TEXT.homeText[lang];
    topicTitle.textContent = TEXT.topicTitle[lang];
    diffTitle.textContent = TEXT.diffTitle[lang];
    btnStartMain.textContent = TEXT.btnMain[lang];
    btnStartReview.textContent = TEXT.btnReview[lang];
    btnSubmit.textContent = TEXT.btnSubmit[lang];
    btnNext.textContent   = TEXT.btnNext[lang];
    btnQuitHome.textContent = TEXT.btnQuitHome[lang];
    btnRestartMain.textContent = TEXT.btnRestartMain[lang];
    btnRestartReview.textContent = TEXT.btnRestartReview[lang];
    btnBackHome.textContent = TEXT.btnBackHome[lang];
    reviewTitle.textContent = TEXT.reviewTitle[lang];
    footer.textContent      = TEXT.footer[lang];

    document.getElementById("lang-ja").classList.toggle("active",lang==="ja");
    document.getElementById("lang-en").classList.toggle("active",lang==="en");

    renderTopicButtons();
    renderDiffButtons();
    updateLastSession();
  }

  document.getElementById("lang-ja").onclick=()=>{lang="ja";applyLanguage();};
  document.getElementById("lang-en").onclick=()=>{lang="en";applyLanguage();};

  // ====== セッション開始 ======
  function startSession(mode){
    let pool;
    if(mode==="review"){
      const ids=getStoredWrongIds();
      pool = QUESTION_BANK.filter(q=>ids.includes(q.id));
      if(!pool.length) pool = QUESTION_BANK;
    } else {
      pool = QUESTION_BANK.filter(q=>{
        const topicOK = (selectedTopic==="all") || (q.topic===selectedTopic);
        const levelOK = (selectedLevel==="all") || (q.level===selectedLevel);
        return topicOK && levelOK;
      });
      if(!pool.length) pool = QUESTION_BANK;
    }

    sessionQuestions = shuffle(pool).slice(0,TOTAL_PER_SESSION);
    sessionAnswers = [];
    currentIndex=0;
    score=0;
    bestStreak=0;
    currentStreak=0;

    btnSubmit.style.display="block";
    btnNext.style.display="none";
    explanationBox.style.display="none";

    showScreen("quiz");
    renderQuestion();
  }

  // ====== 問題表示 ======
  function renderQuestion(){
    const q=sessionQuestions[currentIndex];
    if(!q) return;
    qCounter.textContent = TEXT.qCounter[lang](currentIndex+1,TOTAL_PER_SESSION);
    qTopic.textContent   = TOPIC_DEFS[q.topic]?.[lang] || "";
    badgeText.textContent = (q.level==="basic"?TEXT.levelBasic[lang]:TEXT.levelInter[lang]);
    qText.textContent    = q.q[lang];

    optionsDiv.innerHTML="";
    q.choices.forEach((c,idx)=>{
      const btn=document.createElement("button");
      btn.className="opt-btn";
      btn.dataset.index=idx;
      const letter=document.createElement("span");
      letter.className="letter";
      letter.textContent=String.fromCharCode(65+idx)+".";
      const txt=document.createElement("span");
      txt.textContent=c[lang];
      btn.appendChild(letter);btn.appendChild(txt);
      btn.onclick=()=>{
        if(btnSubmit.disabled) return;
        Array.from(optionsDiv.children).forEach(b=>b.classList.remove("selected"));
        btn.classList.add("selected");
      };
      optionsDiv.appendChild(btn);
    });

    explanationBox.style.display="none";
    expBody.textContent="";

    const prog=Math.round((currentIndex/TOTAL_PER_SESSION)*100);
    progressBar.style.width=prog+"%";

    statCorrect.textContent = TEXT.statCorrect[lang]+": "+score;
    const acc=sessionAnswers.length?Math.round(score/sessionAnswers.length*100):0;
    statAccuracy.textContent=TEXT.statAccuracy[lang]+": "+acc+"%";
  }

  // ====== 回答 ======
  btnSubmit.onclick=()=>{
    const q=sessionQuestions[currentIndex];
    const sel=Array.from(optionsDiv.children).find(b=>b.classList.contains("selected"));
    if(!sel) return;
    const chosen=Number(sel.dataset.index);
    const isCorrect = chosen===q.correct;

    if(isCorrect){score++;currentStreak++;if(currentStreak>bestStreak)bestStreak=currentStreak;}
    else{currentStreak=0;}

    sessionAnswers.push({index:currentIndex,chosen,correct:q.correct,id:q.id});

    Array.from(optionsDiv.children).forEach((b,idx)=>{
      b.onclick=null;
      if(idx===q.correct) b.classList.add("correct");
      if(idx===chosen && idx!==q.correct) b.classList.add("wrong");
    });

    const tag=document.createElement("span");
    tag.className="state-tag";
    tag.textContent=isCorrect?TEXT.correctLabel[lang]:TEXT.wrongLabel[lang];
    sel.appendChild(tag);

    explanationBox.style.display="block";
    expTitle.textContent = TEXT.expTitle[lang];
    expBody.textContent  = q.exp[lang];

    statCorrect.textContent = TEXT.statCorrect[lang]+": "+score;
    const acc=Math.round(score/sessionAnswers.length*100);
    statAccuracy.textContent=TEXT.statAccuracy[lang]+": "+acc+"%";

    btnSubmit.style.display="none";
    btnNext.style.display="block";
  };

  btnNext.onclick=()=>{
    if(currentIndex < TOTAL_PER_SESSION-1){
      currentIndex++;
      btnSubmit.style.display="block";
      btnNext.style.display="none";
      explanationBox.style.display="none";
      renderQuestion();
    }else{
      finishSession();
    }
  };

  // ====== 結果 ======
  function finishSession(){
    const percent=Math.round(score/TOTAL_PER_SESSION*100);
    const wrong=TOTAL_PER_SESSION-score;

    const wrongIds=sessionAnswers.filter(a=>a.chosen!==a.correct).map(a=>a.id);
    localStorage.setItem("chem_last_wrong_ids",JSON.stringify(wrongIds));
    localStorage.setItem("chem_last_score",String(percent));
    localStorage.setItem("chem_last_date",new Date().toISOString());

    renderResult(percent,wrong);
    showScreen("result");
    updateLastSession();
  }

  function renderResult(percent,wrongCount){
    resultTitle.textContent = TEXT.resultTitle[lang];
    resultSummary.textContent = TEXT.resultSummary[lang](score,percent,selectedTopic,selectedLevel);
    resultDetail1.textContent = TEXT.resultDetail1[lang](bestStreak);
    resultDetail2.textContent = TEXT.resultDetail2[lang](wrongCount);

    reviewList.innerHTML="";
    const missed=sessionAnswers.filter(a=>a.chosen!==a.correct);
    if(missed.length){
      reviewTitle.textContent = TEXT.reviewTitle[lang];
      missed.forEach(m=>{
        const q=sessionQuestions[m.index];
        const li=document.createElement("li");
        const qd=document.createElement("div");qd.textContent=q.q[lang];
        const yd=document.createElement("div");yd.className="tag-wrong";
        yd.textContent=TEXT.tagYour[lang]+": "+q.choices[m.chosen][lang];
        const cd=document.createElement("div");cd.className="tag-correct";
        cd.textContent=TEXT.tagCorrect[lang]+": "+q.choices[q.correct][lang];
        const ed=document.createElement("div");ed.className="tag-exp";
        ed.textContent=TEXT.expTitle[lang]+": "+q.exp[lang];
        li.appendChild(qd);li.appendChild(yd);li.appendChild(cd);li.appendChild(ed);
        reviewList.appendChild(li);
      });
      reviewCard.style.display="block";
      btnRestartReview.disabled=false;
    }else{
      reviewCard.style.display="none";
      btnRestartReview.disabled=true;
    }
  }

  // ====== ボタン ======
  btnStartMain.onclick   = ()=>startSession("main");
  btnRestartMain.onclick = ()=>startSession("main");
  btnStartReview.onclick = ()=>startSession("review");
  btnRestartReview.onclick = ()=>startSession("review");
  btnBackHome.onclick    = ()=>showScreen("home");
  btnQuitHome.onclick    = ()=>{
    // 現在の回を破棄してホームへ
    showScreen("home");
  };

  // 初期表示
  renderTopicButtons();
  renderDiffButtons();
  applyLanguage();
  updateLastSession();
</script>
</body>
</html>
